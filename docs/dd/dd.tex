\documentclass[a4paper, 11pt, parskip=half]{scrreprt}

\usepackage[automark]{scrlayer-scrpage}         % Headings
\usepackage{DejaVuSerif}                        % Default font
\usepackage{DejaVuSans}                         % Headers font
\usepackage{sourcecodepro}                      % Monospace font
\usepackage[utf8]{inputenc}                     % Input encoding
\usepackage[T1]{fontenc}                        % Output encoding
\usepackage{graphicx}                           % Pictures
\usepackage{listings}                           % Code snippets
\usepackage{hyperref}                           % Make strings clickable
\usepackage{amsmath,amsfonts,stmaryrd,amssymb}  % Math packages
\usepackage{amsthm}                             % Definitions, theorems, corollaries, ...
\usepackage{mathtools}                          % Math stuff
\usepackage[usenames,dvipsnames,table]{xcolor}  % Colors
\usepackage[toc,page]{appendix}                 % Support for appendices
\usepackage[chapter]{algorithm}                 % Pseudocode headers
\usepackage{algpseudocode}                      % Pseudocode
\usepackage{pdfpages}                           % Embed external pdf
\usepackage{wrapfig}                            % Wrap text around figures
\usepackage{multicol}                           % Used for multicolumn itemize
\usepackage{multirow}                           % Used for multirow in tables
\usepackage{longtable}                          % Tables can spread over multiple pages
\usepackage{enumerate}                          % Custom item numbers for enumerations
\usepackage[framemethod=tikz]{mdframed}         % Allows defining custom boxed/framed environments
\usepackage{tocloft}                            % TOC spacing


% TODO: REMOVE
\usepackage{lipsum}
\usepackage{blindtext}



%----------------------------------------------------------------------------------------
%	DOCUMENT SETTINGS
%----------------------------------------------------------------------------------------

\areaset{17cm}{22.5cm}              % Set page width and height
\graphicspath{{./figures/}}         % Set path for figures
\setlength{\cftchapnumwidth}{2em}   % Set chapter numwidth
\setlength{\cftsecnumwidth}{3em}    % Set section numwidth
\setlength{\cftsubsecnumwidth}{4em} % Set subsection numwidth
\hypersetup{linktoc=all}            % Set TOC clickable

\lstset{ 
    belowcaptionskip=\baselineskip,
    aboveskip=\baselineskip,
    breaklines=true,
    frame=l,
    xleftmargin=0.5in,
    showstringspaces=false,
    basicstyle=\footnotesize\ttfamily,
    keywordstyle=\bfseries\color{green!40!black},
    commentstyle=\color{MidnightBlue},
    stringstyle=\color{BrickRed},
    numberstyle=\color{Cyan!50!Black},
    numbers=left,
    tabsize=4
}

\lstdefinelanguage{swift}{
    morekeywords={
    open,catch,@escaping,nil,throws,func,if,then,else,for,in,while,do,switch,case,default,where,break,continue,fallthrough,return,
    typealias,struct,class,enum,protocol,var,func,let,get,set,willSet,didSet,inout,init,deinit,extension,
    subscript,prefix,operator,infix,postfix,precedence,associativity,left,right,none,convenience,dynamic,
    final,lazy,mutating,nonmutating,optional,override,required,static,unowned,safe,weak,internal,
        private,public,is,as,self,unsafe,dynamicType,true,false,nil,Type,Protocol,
    },
    morecomment=[l]{//}, % l is for line comment
    morecomment=[s]{/*}{*/}, % s is for start and end delimiter
    morestring=[b]", % defines that strings are enclosed in double quotes
    breaklines=true,
    escapeinside={\%*}{*)},
    numbers=left,
    captionpos=b,
    breakatwhitespace=true,
    basicstyle=\linespread{1.0}\ttfamily\footnotesize, % https://tex.stackexchange.com/a/102728/129441
}

\theoremstyle{definition}
\newtheorem{definition}{Definition}[chapter]
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{corollary}{Corollary}[theorem]


%----------------------------------------------------------------------------------------
%	COMMAND LINE ENVIRONMENT
%----------------------------------------------------------------------------------------

% Usage:
% \begin{commandline}
%	\begin{verbatim}
%		$ ls
%		
%		Applications	Desktop	...
%	\end{verbatim}
% \end{commandline}

\mdfdefinestyle{commandline}{
	leftmargin=10pt,
	rightmargin=10pt,
	innerleftmargin=15pt,
	middlelinecolor=black!50!white,
	middlelinewidth=2pt,
	frametitlerule=false,
	backgroundcolor=black!5!white,
	frametitle={Command line},
	frametitlefont={\normalfont\ttfamily\color{white}\hspace{-1em}},
	frametitlebackgroundcolor=black!50!white,
	nobreak,
}

% Define a custom environment for command-line snapshots
\newenvironment{commandline}{
	\medskip
	\begin{mdframed}[style=commandline]
	\footnotesize
}{
	\end{mdframed}
	\medskip
}


%----------------------------------------------------------------------------------------
%	FILE CONTENTS ENVIRONMENT
%----------------------------------------------------------------------------------------

% Usage:
% \begin{file}[optional filename, defaults to "File"]
%	File contents, for example, with a listings environment
% \end{file}

\mdfdefinestyle{file}{
	innertopmargin=1.6\baselineskip,
	innerbottommargin=0.28\baselineskip,
	topline=false, bottomline=false,
	leftline=false, rightline=false,
	leftmargin=2cm,
	rightmargin=2cm,
	singleextra={%
		\draw[fill=black!10!white](P)++(0,-1.3em)rectangle(P-|O);
		\node[anchor=north west]
		at(P-|O){\footnotesize\ttfamily\mdfilename};
		%
		\def\l{1.5em}
		\draw(O-|P)++(-\l,0)--++(\l,\l)--(P)--(P-|O)--(O)--cycle;
		\draw(O-|P)++(-\l,0)--++(0,\l)--++(\l,0);
	},
	nobreak,
}

% Define a custom environment for file contents
\newenvironment{file}[1][File]{ % Set the default filename to "File"
	\medskip
	\newcommand{\mdfilename}{#1}
	\begin{mdframed}[style=file]
}{
	\end{mdframed}
	\medskip
}


%----------------------------------------------------------------------------------------
%	NUMBERED QUESTIONS ENVIRONMENT
%----------------------------------------------------------------------------------------

% Usage:
% \begin{question}[optional title]
%	Question contents
% \end{question}

\mdfdefinestyle{question}{
	innertopmargin=1.2\baselineskip,
	innerbottommargin=0.8\baselineskip,
	roundcorner=5pt,
	nobreak,
	singleextra={%
		\draw(P-|O)node[xshift=1em,anchor=west,fill=white,draw,rounded corners=5pt]{%
		Question \theQuestion\questionTitle};
	},
}

\newcounter{Question} % Stores the current question number that gets iterated with each new question

% Define a custom environment for numbered questions
\newenvironment{question}[1][\unskip]{
	\bigskip
	\stepcounter{Question}
	\newcommand{\questionTitle}{~#1}
	\begin{mdframed}[style=question]
}{
	\end{mdframed}
	\medskip
}


%----------------------------------------------------------------------------------------
%	BOXED PARAGRAPH ENVIRONMENT
%----------------------------------------------------------------------------------------

% Usage:
% \begin{boxedpar}[optional title]
%	Question contents
% \end{boxedpar}

\mdfdefinestyle{boxedpar}{
	innertopmargin=1.2\baselineskip,
	innerbottommargin=0.8\baselineskip,
	roundcorner=5pt,
	nobreak,
	singleextra={%
		\draw(P-|O)node[xshift=1em,anchor=west,fill=white,draw,rounded corners=5pt]{%
		\textit{\boxTitle}};
	},
}

% Define a custom environment for numbered questions
\newenvironment{boxedpar}[1][in-depth]{
	\bigskip
	\newcommand{\boxTitle}{#1}
	\begin{mdframed}[style=boxedpar]
}{
	\end{mdframed}
	\medskip
}


%----------------------------------------------------------------------------------------
%	ROUNDED BOX ENVIRONMENT
%----------------------------------------------------------------------------------------

% Usage:
% \begin{roundedbox}
%	Contents
% \end{roundedbox}

\mdfdefinestyle{roundedbox}{
	innertopmargin=0.5\baselineskip,
	innerbottommargin=0.5\baselineskip,
	roundcorner=5pt,
	nobreak,
}

% Define a custom environment for numbered questions
\newenvironment{roundedbox}{
	\bigskip
	\begin{mdframed}[style=roundedbox]
}{
	\end{mdframed}
	\medskip
}


%----------------------------------------------------------------------------------------
%	WARNING TEXT ENVIRONMENT
%----------------------------------------------------------------------------------------

% Usage:
% \begin{warn}[optional title, defaults to "Warning:"]
%	Contents
% \end{warn}

\mdfdefinestyle{warning}{
	topline=false, bottomline=false,
	leftline=false, rightline=false,
	nobreak,
	singleextra={%
		\draw(P-|O)++(-0.5em,0)node(tmp1){};
		\draw(P-|O)++(0.5em,0)node(tmp2){};
		\fill[black,rotate around={45:(P-|O)}](tmp1)rectangle(tmp2);
		\node at(P-|O){\color{white}\scriptsize\textbf !};
		\draw[very thick](P-|O)++(0,-1em)--(O);%--(O-|P);
	}
}

% Define a custom environment for warning text
\newenvironment{warn}[1][Warning:]{ % Set the default warning to "Warning:"
	\medskip
	\begin{mdframed}[style=warning]
		\noindent{\textbf{#1}}
}{
	\end{mdframed}
}


%----------------------------------------------------------------------------------------
%	INFORMATION ENVIRONMENT
%----------------------------------------------------------------------------------------

% Usage:
% \begin{info}[optional title, defaults to "Info:"]
% 	contents
% 	\end{info}

\mdfdefinestyle{info}{%
	topline=false, bottomline=false,
	leftline=false, rightline=false,
	nobreak,
	singleextra={%
		\fill[black](P-|O)circle[radius=0.4em];
		\node at(P-|O){\color{white}\scriptsize\textbf i};
		\draw[very thick](P-|O)++(0,-0.8em)--(O);%--(O-|P);
	}
}

% Define a custom environment for information
\newenvironment{info}[1][Info:]{ % Set the default title to "Info:"
	\medskip
	\begin{mdframed}[style=info]
		\noindent{\textbf{#1}}
}{
	\end{mdframed}
}


%----------------------------------------------------------------------------------------
%	LINEDQUOTE ENVIRONMENT
%----------------------------------------------------------------------------------------

% Usage:
% \begin{linedquote}
% 	contents
% 	\end{linedquote}

\mdfdefinestyle{linedquote}{%
	topline=false, bottomline=false,
	leftline=false, rightline=false,
	nobreak,
	singleextra={%
		\draw[very thick](P-|O)++(0,0)--(O);%--(O-|P);
	}
}

% Define a custom environment
\newenvironment{linedquote}{
	\begin{mdframed}[style=linedquote]
}{
	\end{mdframed}
}


%----------------------------------------------------------------------------------------
%	TITLE PAGE
%----------------------------------------------------------------------------------------

\publishers{
    \begin{figure}[t]
        \centering
        \includegraphics[width=0.9\linewidth, keepaspectratio]{logo}
    \end{figure}
}
\title{Smart Tourist}
\subtitle{Design and Implementation of Mobile Applications\\Design Document}
\date{A.Y. 2019/2020}
\author{Fabio Codiglioni, Alessandro Nichelini}



%----------------------------------------------------------------------------------------
%	DOCUMENT
%----------------------------------------------------------------------------------------

\begin{document}

% Title page and TOC
\pagenumbering{gobble}
\maketitle
%\shipout\null           % Blank page
\pagenumbering{roman}
\tableofcontents
\newpage
\pagenumbering{arabic}


% Body

\chapter{Introduction}

This is the \textit{design document} (DD) of the \textbf{\textit{Smart Tourist}} iOS application developed by \textit{Fabio Codiglioni} and \textit{Alessandro Nichelini} in the context of the \textit{Design and Implementation of Mobile Application} course at Politecnico di Milano. The authors have been tutored by \textit{Bending Spoons} for the usage of some technologies that are described later.\\
The document explains the most important design choices we made and the motivations behind them, with specific focus on the Redux-like architecture adopted.




\chapter{General Overview}

Smart Tourist is a multi-device application for iOS, iPadOS and watchOS.

\section{Assignment}
For the reader convenience, the (free) original assignment is reported below:
\begin{info}[Assignment:]
	 Smart Tourist
	 \\\\Help your users when they are exploring new cities!
	 \\\\By using the localization systems on the smartphones and the Google Places API, notify the user when something interesting is nearby.
	 \\\\Connect to Wikipedia to retrieve interesting information on the selected point of interest.
	 \\\\Search and filter among several interesting places of the city you are visiting, save them as favorites so you can check on them later.
	 \\\\Attach some pictures to those pins and eventually share them with your friends!
\end{info}

\section{Features description}

\subsection{Exploring}
The user is given a navigation map filled with the city's points of interest. They have the chance to control which attractions to see on a map. They can choose between \textit{nearest places}, \textit{popular places} and \textit{favorites}. Each attraction is shown on the map and in a list view, and is clickable from both position to open the corresponding detail view.
\\\\In the map, two circles are displayed to help the user better understand distances. These circles correspond to the distance they can cover in 5 and 15 minutes. Circles' radius is automatically updated with information from user profile and thus they always fit with the user's pace.

\subsection{Dynamic exploring}
SmartTourist works well in both crowded cities and small towns. The user will be always provided with the right amount of attractions. In places where not so many attractions are available, the app will automatically show less known attraction and particular point of interest.

\subsection{Learning}
The user can open the detail view of both the city and attractions. They will be provided with useful information about the point of interest, such as pictures, Wikipedia description, useful links and a shortcut to open turn-by-turn navigation.

\subsection{Notifications}
The user is notified when they are nearby a "top location". The notification comes with a picture of the attraction and lets them open either the the detail view of the attraction or the turn-by-turn navigation. 

\subsection{Keep track of favorite attractions}
The user can view the attractions of her current city or they can have a preview of other cities attractions. In both case they can keep track of them by adding them in the list of favorite attractions. The user is also provided the ability to open a worldwide map with all their favorite places.

\subsection{Contribute (proof of concept)}
SmartTourist is manly based on free data. When a detailed description is missing, the user is given the chance to contribute.




\chapter{Architectural design}

SmartTourist is a self-contained application. No external backend services are provided by us, instead it relies on a multitude of internal iOS/iPadOS services and third parties API.
\\Here it follows a schema that summarizes them all:

\begin{figure}[H]
  	\centering
  	\includegraphics[width=0.5\linewidth]{ArchitectureOverview}
  	\label{fig:test1}
	\caption{Architecture overview}
\end{figure}

Internal application design is strongly influenced by the choice of the Katana/Tempura framework that forced the adoption of a MVVM paradigm.

\section{Katana}
Quoting from Katana's \href{https://github.com/BendingSpoons/katana-swift}{documentation}\footnote{https://github.com/BendingSpoons/katana-swift}:
\\Katana is a modern Swift framework for writing iOS applications' business logic that are testable and easy to reason about. It is strongly inspired by Redux.

In a few words, the app state is entirely described by a single serializable data structure, and the \underline{only way to change the state is to dispatch a StateUpdater}. 
\begin{itemize}
	\item SmartTourist \textbf{state} is quite complex, here it follows the main structure:
		
		\begin{lstlisting}[language=swift]
struct AppState: State, Codable {
	var locationState = LocationState()
	var favorites = [WDPlace]()
	var settings = Settings()
	var pedometerState = PedometerState()
	var cache = Cache()
	var needToMoveMap = false
	...
}
		\end{lstlisting}
		
		\begin{info}
			Notice that since the main state was becoming very complex, the authors decided to pack inside it instances of different structures. Details in the \href{https://github.com/Alenichel/CodiglioniNichelini-DIMAProject/blob/master/SmartTourist/State/AppState.swift}{source code}.
		\end{info}
		
	\item A \textbf{StateUpdater} is an intent to transform the state, and contains all the information to do so. Because all the changes are centralized and are happening in a strict order, there are no subtle race conditions to watch out for.
		\\For practical examples, the reader is invited to directly refers to the \href{https://github.com/Alenichel/CodiglioniNichelini-DIMAProject/blob/master/SmartTourist/State/StateUpdaters.swift}{source file}\footnote{https://github.com/Alenichel/CodiglioniNichelini-DIMAProject/blob/master/SmartTourist/State/StateUpdaters.swift}.	 
	\item Updating the application's state using pure functions is nice and it has a lot of benefits. Applications have to deal with the external world though (e.g., API call, disk files management, …). For all this kind of operations, Katana provides the concept of \textbf{SideEffects}. SideEffects can be used to interact with other parts of your applications and then dispatch new StateUpdaters to update your state.
		\\SmartTourist features side effects to handle API calls to both Wikipedia and Google services. They are available, \href{https://github.com/Alenichel/CodiglioniNichelini-DIMAProject/blob/master/SmartTourist/State/SideEffects.swift}{here}\footnote{https://github.com/Alenichel/CodiglioniNichelini-DIMAProject/blob/master/SmartTourist/State/SideEffects.swift}.
\end{itemize}


\section{Tempura}
Quoting from Tempura's \href{https://github.com/BendingSpoons/tempura-swift}{documentation}\footnote{https://github.com/BendingSpoons/tempura-swift}: \textit{Tempura is a holistic approach to iOS development, it borrows concepts from Redux (through Katana) and MVVM}.

\begin{figure}[H]
  	\centering
  	\includegraphics[width=0.9\linewidth]{mvvm}
  	\label{fig:test1}
	\caption{MVVM architecture overview}
\end{figure}

Tempura uses Katana to handle the logic of your app: the part of the state needed to render the UI of a screen is selected by a \textit{ViewModelWithState}.
\\The UI of each screen of your app:
\begin{itemize}
	\item  is composed in a \textit{ViewControllerModellableView}. It exposes callbacks (we call them \textit{interactions}) to signal that a user action occurred. It renders itself based on the \textit{ViewModelWithState}
	\item is managed by a \textit{ViewController}. Out of the box it will automatically listen for state updates and keep the UI in sync. The only other responsibility of a ViewController is to listen for interactions from the UI and dispatch actions to change the state.
\end{itemize}

\begin{lstlisting}[language=swift]
struct ListViewModel: ViewModelWithState {
    var todos: [Todo]
    
    init(state: AppState) {
        self.todos = state.todos
    }
}

class ListView: UIView, ViewControllerModellableView {
    // subviews
    var todoButton: UIButton = UIButton(type: .custom)
    var todoButton: UIButton = UIButton(type: .custom)
    var list: CollectionView<TodoCell, SimpleSource<TodoCellViewModel>>
    
    // interactions
    var didTapAddItem: ((String) -> ())?
    var didCompleteItem: ((String) -> ())?
    
    // update based on ViewModel
    func update(oldModel: ListViewModel?) {
        guard let model = self.model else { return }
        let todos = model.todos
        self.list.source = SimpleSource<TodoCellViewModel>(todos)
    }
}
\end{lstlisting}
\newpage
\begin{lstlisting}[language=swift]
class ListViewController: ViewController<ListView> {
    // listen for interactions from the view
    override func setupInteraction() {
        self.rootView.didCompleteItem = { [unowned self] index in
            self.dispatch(CompleteItem(index: index))
        }
    }
}
\end{lstlisting}



\chapter{Services and libraries}

\section{Internal libraries}

SmartTourist uses consistently internal libraries and services:

\begin{itemize}
    \item \textbf{\textit{Core Location}}: for location updates.
	\item \textbf{\textit{MapKit}}: for maps.
	\item \textbf{\textit{Core Motion}}: for accessing accelerometer, gyroscope, pedometer, and environment-related events.
\end{itemize}

\section{External services}

SmartTourist relies almost only on \textit{free data and services}. 

\begin{info}
The choice to rely on free services has been carefully pondered and it costed the authors some troubles. SmartTourist has been designed to be a free application in an eventual public launch, thus it would be impossible to support the cost of Google Places API without any premium subscription. Moreover, the authors strongly believe in the Wikidata project and wanted to work with it.
\end{info}

Here, it follows the description of the external services used.

\begin{itemize}
	\item \textit{\textbf{Wikipedia}} \\
	All displayed attractions are taken from the Wikidata knowledge base. The given API is quite basic: attraction entries are retrieved with a SPARQL query embedded in a HTTP API call, while details and pictures are retrieved with standard HTTP API calls from different endpoints.
		
	\begin{lstlisting}[language=sql, caption={SPARQL query for attraction retrieving}, captionpos=b]
SELECT DISTINCT ?place ?placeLabel ?location ?image 
                ?instance ?website ?wikipediaLink WHERE {
    SERVICE wikibase:label { bd:serviceParam wikibase:language "en, it" }
    SERVICE wikibase:around {
        ?place wdt:P625 ?location .
        bd:serviceParam wikibase:center "Point(\(location.longitude) \(location.latitude))"^^geo:wktLiteral .
        bd:serviceParam wikibase:radius "\(radius)" .
    }
    ?place wdt:P31 ?instance  .
    ?place wdt:P18 ?image .
    OPTIONAL {?place wdt:P856 ?website} .
    OPTIONAL {?wikipediaLink schema:about ?place;
        schema:inLanguage "en";
        schema:isPartOf [ wikibase:wikiGroup "wikipedia" ]} .
}
	\end{lstlisting}
		
	\begin{lstlisting}[language=sql, caption={SPARQL query for city detail retrieving}, captionpos=b]
SELECT DISTINCT ?city ?cityLabel ?country ?countryLabel ?population ?area
                ?elevation ?link ?facebookPageId ?facebookPlacesId
                ?instagramUsername ?twitterUsername ?image ?coatOfArmsImage
                ?cityFlagImage ?countryCode ?wikipediaLink WHERE {
    BIND( <http://www.wikidata.org/entity/\(cityId)> as ?city ).
    OPTIONAL {?city wdt:P17 ?country}.
    OPTIONAL {?city wdt:P1082 ?population}.
    OPTIONAL {?city wdt:P2046 ?area}.
    OPTIONAL {?city wdt:P2044 ?elevation}.
    OPTIONAL {?city wdt:P856 ?link}.
    OPTIONAL {?city wdt:P2013 ?facebookPageId}.
    OPTIONAL {?city wdt:P1997 ?facebookPlacesId}.
    OPTIONAL {?city wdt:P2003 ?instagramUsername}.
    OPTIONAL {?city wdt:P2002 ?twitterUsername}.
    OPTIONAL {?city wdt:P18 ?image}.
    OPTIONAL {?city wdt:P94  ?coatOfArmsImage}.
    OPTIONAL {?city wdt:P41 ?cityFlagImage}.
    OPTIONAL {?country wdt:P297 ?countryCode}.
    OPTIONAL {?wikipediaLink schema:about ?city;
      schema:inLanguage "en";
      schema:isPartOf [ wikibase:wikiGroup "wikipedia" ]}.
    SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }
}
	\end{lstlisting}
		
	\item \textit{\textbf{Google}} \\
	Places ratings are the only data retrieved from Google services. This was due to the lack of a reliable free alternative. For the simplicity of the task, we decided not to rely on the Google SDK for iOS and to manually make request to the Google API.
\end{itemize}

\section{External libraries}

The app uses a multitude of third-party libraries that can be roughly divided into three kind: architectural libraries, back-end libraries and front-end libraries.

\begin{table}[h]
    \centering
    \def\arraystretch{1.3}
    \begin{tabular}{|c|c|m{9cm}|}
        \hline
        \textbf{Kind} & \textbf{Library} & \textbf{Description} \\ \hline
        \multirow{2}{*}{Architectural} & Katana & Katana is a modern Swift framework for writing iOS applications' business logic that are testable and easy to reason about. Katana is inspired by Redux. \\ \cline{2-3}
        & Tempura & Tempura is a holistic approach to iOS development, it borrows concepts from Redux (through Katana) and MVVM. \\ \hline
        \multirow{5}{*}{Back-end} & DeepDiff & DeepDiff tells the difference between 2 collections and the changes as edit steps. \\ \cline{2-3}
        & Fuse & Fuse is a super lightweight library which provides a simple way to do fuzzy searching. \\ \cline{2-3}
        & Alamofire & Alamofire is an HTTP networking library written in Swift. \\ \cline{2-3}
        & SwiftyXMLParser & Simple XML Parser implemented in Swift. \\ \hline
        \multirow{7}{*}{Front-end} & PinLayout & Extremely fast views layouting without auto layout. No magic, pure code, full control and blazing fast. Concise syntax, intuitive, readable and chainable. PinLayout can layouts UIView, NSView and CALayer. \\ \cline{2-3}
        & FlexLayout & Angular Flex Layout provides a sophisticated layout API using Flexbox CSS + mediaQuery. \\ \cline{2-3}
        & Cosmos & This is a UI control for iOS and tvOS written in Swift. \\ \cline{2-3}
        & ImageSlideshow & Customizable Swift image slideshow with circular scrolling, timer and full screen viewer. \\ \cline{2-3}
        & MarqueeLabel & MarqueeLabel is a UILabel subclass adds a scrolling marquee effect when the text of the label outgrows the available width. \\ \cline{2-3}
        & FontAwesome & Use Font Awesome in your Swift projects. \\ \cline{2-3}
        & FlagKit & Beautiful flag icons for usage in apps and on the web. \\ \hline
    \end{tabular}
\end{table}

\chapter{User interface}
For the user interface design, we followed Apple's UI guidelines, but we preferred also to use custom UI element to better fit Katana/Tempura paradigm's requirements and to let the app have a modern and captivating style.  

\section{Screenshots}
Here follow some screenshots of the application in both Light and Dark mode.

\subsection{MapView}

\subsubsection{MapView - nearest places}

\begin{figure}[H]
	\centering
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/light_nearest}
  	\label{fig:test1}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/dark_nearest}
  	\label{fig:test2}
	\end{minipage}
	\caption{Map view with nearest tab selected in both light and dark mode}
\end{figure}

This is the first view that appears when you open the app. Attractions, up to the maximum selected number, are displayed both in the maps and in the list below. In the list, they are ordered by their distance to the user current position.
\\In this view you can tap the city name to open the city detail view or an attraction to open the corresponding detail view. By tapping the search button, the user is presented with the familiar search bar. Settings are reachable by tapping the gear button near the selectors.
\\The tab view for attraction list is resizable.

\subsection{MapView - popular places}

\begin{figure}[H]
	\centering
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/light_popular}
  	\label{fig:test1}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/dark_popular}
  	\label{fig:test2}
	\end{minipage}
	\caption{Map view with popular tab selected in both light and dark mode}
\end{figure}

Same as the previous view, but here the popular tab is selected. Thus, only the most popular places are displayed. In the list, favorite items are identified by a hearth icon and the rating of each attraction is also displayed.
\\In this screenshot, circles that represent distance are more visible. They respectively represent the distance that the user can cover by walking at their current walking speed in 5 and 15 minutes, respectively.

\subsection{MapView - favorite places}

\begin{figure}[H]
	\centering
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/light_favourite}
  	\label{fig:test1}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/dark_favourite}
  	\label{fig:test2}
	\end{minipage}
	\caption{Map view with favorite tab selected in both light and dark mode}
\end{figure}

Same as the previous view, but here the favorite tab is selected. Since it's a global tab, they are grouped by city, that is also displayed. 
\\An additional button with a map is displayed, to let the user access the global view of favorite items.

\subsection{Global favorite view}

\begin{figure}[H]
	\centering
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/light_worldwide}
  	\label{fig:test1}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/dark_worldwide}
  	\label{fig:test2}
	\end{minipage}
	\caption{Favorite worldwide view in both light and dark mode}
\end{figure}

In this view, all user's favorite attractions are displayed in a fullscreen map. 

\subsection{Searching view}

\begin{figure}[H]
	\centering
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/light_searching}
  	\label{fig:test1}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/dark_searching}
  	\label{fig:test2}
	\end{minipage}
	\caption{Searching view in both light and dark mode}
\end{figure}

When you tap the lens button on the map view, the familiar searching view provided by iOS is opened. Both cities and attractions can be searched.

\subsection{Attraction detail view}

\begin{figure}[H]
	\centering
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/light_detail_view}
  	\label{fig:test1}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/dark_detail_view}
  	\label{fig:test2}
	\end{minipage}
	\caption{Attraction detail view in both light and dark mode}
\end{figure}

This is the detailed view that is presented when the user tap a specific attraction. A slideshow of pictures of the attraction is displayed together with the rating (if available) and buttons that let you access the map direction, the complete Wikipedia Article and the related website.
In the navigation bar, the back button is available together with the hearth button that lets the user mask the attraction as favorite. The view is scrollable to display the entire place description extract. A detailed map with the specific attraction location is also provided at the bottom. 

\subsection{City detail view}

\begin{figure}[H]
	\centering
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/light_city_detail_view}
  	\label{fig:test1}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/dark_city_detail_view}
  	\label{fig:test2}
	\end{minipage}
	\caption{City detail view in both light and dark mode}
\end{figure}

This is the city detail view that is displayed when the user tap the city name in the main view. A pictures slideshow is displayed together with some information such as: population, area and altitude. A set of social links is retrieved and presented to the user. The view is scrollable and a summary description of the city is given.


\subsection{Settings view}

\begin{figure}[H]
	\centering
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/light_settings}
  	\label{fig:test1}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/dark_settings}
  	\label{fig:test2}
	\end{minipage}
	\caption{Settings view in both light and dark mode}
\end{figure}

Settings view is displayed when the gear icon on the main view is tapped. This is a quite standard settings view where some parameters about the application can be set.




\chapter{Notifications}

Notifications are designed as a way for the user not to miss popular attraction near them. Each time the user is in a 5 minutes range of a popular attraction, a notification is triggered. This works in both background and foreground mode ("\textit{always active}" location tracking is required).
\\The shown notification is a \textit{rich notification} with callbacks: \textbf{take me there} will directly open navigation app with that attraction as destination and \textbf{view} will open SmartTourist detail attraction view.

\begin{figure}[H]
	\centering
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/notification_background}
  	\label{fig:test1}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
  	\centering
  	\includegraphics[width=0.98\linewidth]{/screenshot/notification_rich}
  	\label{fig:test2}
	\end{minipage}
	\caption{Notification layouting}
\end{figure}




\chapter{Testing}

\section{Unit testing}

The application does not contain any part that is suitable for unit testing. This is due to the fact that its core functionality can be reduced to making API calls and displaying the results back to the user. It is well known that there are too many variables involved in API calls that make them unsuitable for unit testing.

\section{UI testing}

Since we didn't use the standard Apple SDK to layout views -- we just used its components -- we couldn't use the provided UI testing framework. Luckily, Tempura provides its own UI testing framework, which is a little different than Apple's. Basically, it allows to take screenshots of a view in all possible states, with all devices and all supported languages. This way you can then manually check that all the components of a view are correctly displayed.

Unfortunately, we were not able to make this framework work due to the highly asynchronous nature of our main views, an approach suggested by our Bending Spoons tutor in order to make the views more responsive.




\chapter{Future development}

During the development of the application, we encountered a series of issues that would require some more work in case of a public release. In particular, in order to provide a premium-grade service to our users, a better data integration system is required. The perfect solution would be to build a custom backend that integrates Wikipedia and Google data when requested, storing the results for quicker future lookup. 

% TODO: continue




\chapter{Effort spent}

The actual development took place between January 2020 and May 2020, while during July/August 2020 just some minor changes have been put in place, together with the drafting of all the needed documents and materials.
\\\\The authors worked together on site and remotely to setup the crucial parts of the application, then, they worked mostly on their own with continuous mutual contacts. They also had a couple of starting tutoring session kindly offered by Bending Spoons at their HQ to learn the Katana/Tempura framework.
\\\\They didn't use any professional time tracker, but it's safe to assume that the total amount of time spent is around 300 hours per worker, roughly divided in this way:

\begin{itemize}
	\item 20\% platform meet and greet
	\item 35\% actual development
	\item 15\% free services refactoring
	\item 10\% testing
	\item 20\% documents drafting
\end{itemize}

\end{document}
